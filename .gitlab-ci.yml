variables:
  GIT_DEPTH: 1
  GIT_CLONE_PATH: $CI_BUILDS_DIR/$CI_PROJECT_PATH/$CI_ENVIRONMENT_SLUG
  GIT_CLEAN_FLAGS: -ffdx -e .env -e config.yaml

stages:
  - prepare
  - build
  - down
  - up

# üõ†Ô∏è 1Ô∏è‚É£ Vorbereitung: SSH-Tools installieren
prepare-job:
  stage: prepare
  before_script:
    - "echo SHELL: $SHELL"
    - "echo 0: $0"
    - "ps -o comm= -p $$"  # zeigt, welcher Shell-Prozess l√§uft
  script:
    - whoami
    - echo $HOME
  tags:
    - deploy
  only:
    - main
    - master

# üîê 2Ô∏è‚É£ SSH-Konfiguration vorbereiten
build-job:
  stage: build
  needs: ["prepare-job"]
  script:
    - docker compose build
    #- docker compose build --no-cache
  tags:
    - deploy
  only:
    - main
    - master

# üîÑ 3Ô∏è‚É£ Dateien synchronisieren (Deploy)
down-job:
  stage: down
  needs: ["build-job"]
  script:
    - docker compose down
  tags:
    - deploy
  only:
    - main
    - master

# ‚úÖ 4Ô∏è‚É£ Nachpr√ºfung (optional, sehr empfehlenswert)
up-job:
  stage: up
  needs: ["down-job"]
  script:
    - docker compose up -d
  tags:
    - deploy
  only:
    - main
    - master